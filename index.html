 <script src="https://cdn.tailwindcss.com"></script>
<style>
	body {
		margin: 10px !important;
	}
</style>
<form id="form" name="form" >


<label for="dropzone-file" class="block mb-2 text-sm font-medium text-gray-900">Image</label>
<div class="flex items-center justify-center w-full">
    <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-25 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-bray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
        <div class="flex flex-col items-center justify-center pt-5 pb-6">
            <svg class="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
            </svg>
            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">SVG, PNG, JPG</p>
        </div>
        <input id="dropzone-file" type="file" name="image" class="hidden" />
    </label>
		</div>
</div> 
<img width="512" id="input_image" />
<img src="" id="image">
<label for="mask_detect_prompt" class="block mb-2 text-sm font-medium text-gray-900">what to replace prompt</label>
<textarea name="mask_detect_prompt" id="mask_detect_prompt"  rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Leave a comment...">only dress</textarea>
<label class="block mb-2 text-sm font-medium text-gray-900">replace to prompt</label>
<textarea type="text" value="" name="prompt" id="prompt" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">fairy tail costume</textarea>
<label class="block mb-2 text-sm font-medium text-gray-900">negative prompt</label>
<textarea type="text" value="" name="prompt2" id="negative_prompt" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">extra legs,(deformed iris, deformed pupils, semi-realistic, cgi, 3d, render, sketch, cartoon, drawing, anime:1.4), text, close up, cropped, out of frame, worst quality, low quality, jpeg artifacts, ugly, duplicate, morbid, mutilated, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, blurry, bad anatomy, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, fused fingers, too many fingers, long neck</textarea>
<br />
<input type="submit" id="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" value="Generate" />
</form>
<button id="cancel" disabled="true" class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-red-800">Cancel job</button>
<div class="timer" id="timer"></div>
<div>
<img width="512" id="result" /></div>

<script>
	var apikey = 'UOM9JEA59ORKWATNUV7WBKZ6LVEXWITF3SLAMZA3'
	var serverid = 'qcgxgvcdnisbtg'
	var maxWidth = 1024

	const resizeImage = async (
	  url,
	  options = {
	    maxWidth: 1024,
	    maxHeight: 2000,
	    contentType: "image/png",
	    quality: 0.7
	  }
	) => {
	  const calculateSize = (img) => {
	    let w = img.width,
	      h = img.height;
	    if (w > h) {
	      if (w > options.maxWidth) {
	        h = Math.round((h * options.maxWidth) / w);
	        w = options.maxWidth;
	      }
	    } else {
	      if (h > options.maxHeight) {
	        w = Math.round((w * options.maxHeight) / h);
	        h = options.maxHeight;
	      }
	    }
	    return [w, h];
	  };

	  return new Promise((resolve) => {
	    const img = new Image();
	    img.src = url;
	    img.onerror = function () {
	      URL.revokeObjectURL(this.src);
	    };
	    img.onload = function () {
	      URL.revokeObjectURL(this.src);
	      const [newWidth, newHeight] = calculateSize(
	        img,
	        options.maxWidth,
	        options.maxHeight
	      );
	      const canvas = document.createElement("canvas");
	      canvas.width = newWidth;
	      canvas.height = newHeight;
	      const ctx = canvas.getContext("2d");
	      ctx.drawImage(img, 0, 0, newWidth, newHeight);

	      const resultUrl = canvas.toDataURL(options.contentType, options.quality),
	        result = {
	          url: resultUrl,
	          contentType: resultUrl.match(/^data\:([^\;]+)\;base64,/im)[1] || "",
	          b64: resultUrl.replace(/^data\:([^\;]+)\;base64,/gim, "")
	        };

	      canvas.toBlob(
	        (blob) => {
	          result.size = blob.size;
	          resolve(result);
	        },
	        options.contentType,
	        options.quality
	      );
	    };
	  });
	};

	function getBase64(file) {
	  return new Promise((resolve, reject) => {
	    const reader = new FileReader();
	    reader.readAsDataURL(file);
	    reader.onload = () => resolve(reader.result);
	    reader.onerror = error => reject(error);
	  });
	}




	var fileToRead = document.getElementById("dropzone-file");

	fileToRead.addEventListener("change", function(event) {
	    var files = fileToRead.files;
	    getBase64(files[0]).then(async (data) => {
	    	document.getElementById('input_image').src = data;
	    })

	}, false);

	document.querySelector('#cancel').addEventListener('click', e => {
		const url = `https://api.runpod.ai/v2/${serverid}/cancel/${window.currentJobId}`
		fetch(url, {
		  method: 'post',
		  mode: 'cors',
		  headers: new Headers({
		    'Content-Type': 'application/json',
		    'Authorization': `Bearer ${apikey}`
		  })
		})
		document.querySelector('#cancel').setAttribute('disabled', true)
	})

	function setToSecondsToNull() {
		document.querySelector('#timer').innerHTML = "0"
	}

	function updateSeconds() {
		var sec = parseFloat(document.querySelector('#timer').innerHTML)
		sec++;
		document.querySelector('#timer').innerHTML = sec;
	}

	function startTimer() {
		setToSecondsToNull()
		window.currentInterval = setInterval("updateSeconds()", 1000)
	}

	function checkStatus(jobId) {
	  const url = `https://api.runpod.ai/v2/${serverid}/status/${jobId}`
		fetch(url, {
		  method: 'post',
		  mode: 'cors',
		  headers: new Headers({
		    'Content-Type': 'application/json',
		    'Authorization': `Bearer ${apikey}`
		  })
		})
		.then(response => response.json())
		.then(json => {
			if (json.status.toLowerCase() === 'failed') {
				clearInterval(window.currentInterval);
				alert(JSON.stringify(json))
				return
			}
			if (json.output) {
				clearInterval(window.currentInterval);
				document.getElementById('result').src = `data:image/png;base64,${json.output.images[0]}`
			} else {
				setTimeout(() => { checkStatus(jobId) }, 2000);
			}
		})
		.catch((e) => {
			setTimeout(() => { checkStatus(jobId) }, 2000);
		})
	}

	setToSecondsToNull()

	document.querySelector('#form').addEventListener('submit', e => {
		document.querySelector('#button').setAttribute('disabled', true)
	  e.preventDefault();

	  const url = `https://api.runpod.ai/v2/${serverid}/runsync`

	  const dataToPost = {
		    "input": {
		        "api": {
		            "method": "pic_replace",
		            "endpoint": "/sam/sam-predict"
		        },
		        "payload": [
		            {
		                "sam_model_name": "sam_vit_h_4b8939.pth",
		                "input_image": "",
		                "sam_positive_points": [],
		                "sam_negative_points": [],
		                "dino_enabled": true,
		                "dino_model_name": "GroundingDINO_SwinT_OGC (694MB)",
		                "dino_text_prompt": document.getElementById('mask_detect_prompt').value,
		                "dino_box_threshold": 0.18,
		                "dino_preview_checkbox": false,
		                "dino_preview_boxes_selection": [2]
		            },
		            {
		                "prompt": document.getElementById('prompt').value,
		                "negative_prompt": document.getElementById('negative_prompt').value,
								    "inpainting_fill": 1,
								    "inpaint_full_res": 0,
								    "inpaint_full_res_padding": 32,
								    "inpainting_mask_invert": 0,
								    "include_init_images": true,
								    "initial_noise_multiplier": 1,
								    "script_name": "",
								    "script_args": [],
								    "send_images": true,
								    "save_images": false,
								    "alwayson_scripts": {},
								    "styles": [],
								    "seed": -1,
								    "subseed": -1,
								    "subseed_strength": 0,
								    "seed_resize_from_h": -1,
								    "seed_resize_from_w": -1,
								    "sampler_name": "DPM++ 2M Karras",
								    "extra_generation_params": {"Mask blur": 4},
								    "batch_size": 1,
								    "n_iter": 1,
								    "seed_enable_extras": true,
								    "ddim_discretize": null,
								    "steps": 35,
								    "cfg_scale": 8,
								    "width": 965, 
								    "height": 690, 
								    "restore_faces": false,
								    "tiling": false,
								    "do_not_save_samples": false,
								    "do_not_save_grid": false,
								    "eta": null,
								    "denoising_strength": 0.75,
								    "s_min_uncond": 0,
								    "s_churn": 0,
								    "s_tmax": null,
								    "s_tmin": 0,
								    "s_noise": 1,
								    "sd_model_name": "realisticVisionV51inpaint",
								    "override_settings_restore_afterwards": true,
								    "refiner_switch_at": 0,
								    "disable_extra_networks": false,
								    "comments": {},
								    "resize_mode": 0,
								    "image_cfg_scale": null,
								    "mask_blur_x": 4,
								    "do_not_reload_embeddings": false,
								    "mask_blur_y": 4,
								    "mask_blur": 4
		            }
		        ]
		    }
		}

		startTimer()

		var file = document.querySelector('input[type="file"]').files[0];
		getBase64(file).then(async (data) => {
			let img;
			// if (resizeTo > 1024) {
				// img = await resizeImage(data, {
				//   maxWidth: maxWidth
				// });
			// }

			dataToPost.input.payload[0].input_image = img?.b64 || data;
			
			fetch(url, {
			  method: 'post',
			  body: JSON.stringify(dataToPost),
			  mode: 'cors',
			  headers: new Headers({
			    'Content-Type': 'application/json',
			    'Authorization': `Bearer ${apikey}`
			  })
			})
			.then(response => response.json())
			.then(json => {
				document.querySelector('#button').removeAttribute('disabled')
				window.currentJobId = json.id
				
				if (json.output) {
					clearInterval(window.currentInterval);
					document.getElementById('result').src = `data:image/png;base64,${json.output.images[0]}`
				} else {
					document.querySelector('#cancel').removeAttribute('disabled')
					checkStatus(json.id)
				}
			})
			.catch((e) => {

				console.error(e);
				setToSecondsToNull();
			})
		});


	});
</script>